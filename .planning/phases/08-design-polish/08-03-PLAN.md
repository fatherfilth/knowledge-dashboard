---
phase: 08-design-polish
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/lib/toc.ts
  - src/components/ui/ArticleSidebar.tsx
  - src/app/[category]/[slug]/page.tsx
  - src/components/ui/RelatedArticles.tsx
autonomous: true

must_haves:
  truths:
    - "Article page has two-column layout: 260px sticky sidebar + fluid content area"
    - "Sidebar contains status badge, author, dates, tags, and table of contents"
    - "Table of contents extracts h2 and h3 headings from article content"
    - "TOC links navigate to headings within the article"
    - "Sidebar collapses to metadata grid above content on tablet (< 64rem)"
    - "Sidebar goes single-column on small mobile (< 30rem)"
    - "Article header shows category link, title with accent bar, back button as pill"
    - "Related articles display as 3-column grid with colored top borders"
    - "Prose styling has dark theme with teal links, purple blockquotes, styled code"
  artifacts:
    - path: "src/lib/toc.ts"
      provides: "TOC extraction from markdown using remark AST traversal"
      exports: ["extractToc", "TocHeading"]
    - path: "src/components/ui/ArticleSidebar.tsx"
      provides: "Sticky sidebar with metadata, tags, and TOC"
      contains: "sticky"
    - path: "src/app/[category]/[slug]/page.tsx"
      provides: "Two-column article layout with sidebar and content"
      contains: "grid-cols-[260px_1fr]"
    - path: "src/components/ui/RelatedArticles.tsx"
      provides: "3-column related articles grid with colored top borders"
      contains: "border-t-2"
  key_links:
    - from: "src/app/[category]/[slug]/page.tsx"
      to: "src/lib/toc.ts"
      via: "extractToc function call"
      pattern: "extractToc"
    - from: "src/app/[category]/[slug]/page.tsx"
      to: "src/components/ui/ArticleSidebar.tsx"
      via: "ArticleSidebar component"
      pattern: "ArticleSidebar"
    - from: "src/components/ui/ArticleSidebar.tsx"
      to: "src/lib/toc.ts"
      via: "TocHeading type"
      pattern: "TocHeading"
---

<objective>
Redesign the article page with a two-column layout featuring a sticky sidebar (TOC, metadata, tags), redesigned prose styling for dark mode, and polished related articles grid.

Purpose: The article reader is the core user experience. The two-column layout with sticky sidebar enables navigation within long articles while displaying rich metadata. This is the most structurally significant change in the design polish.
Output: TOC extraction utility, ArticleSidebar component, redesigned article page, restyled RelatedArticles.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-design-polish/08-CONTEXT.md
@.planning/phases/08-design-polish/08-RESEARCH.md
@.planning/phases/08-design-polish/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TOC extraction utility and ArticleSidebar component</name>
  <files>src/lib/toc.ts, src/components/ui/ArticleSidebar.tsx</files>
  <action>
**src/lib/toc.ts — New file: Table of contents extraction from markdown**

Uses the `unified` + `remark-parse` pipeline (already installed) with `unist-util-visit` to traverse the AST and extract h2/h3 headings. Do NOT install remark-extract-toc — hand-roll with visit since the dependency is already available via unified ecosystem.

First check if `unist-util-visit` is installed. If not, install it: `npm install unist-util-visit`

```typescript
import { unified } from "unified";
import remarkParse from "remark-parse";
import { visit } from "unist-util-visit";

export interface TocHeading {
  depth: number;
  text: string;
  slug: string;
}

/**
 * Extract h2 and h3 headings from markdown content for table of contents
 */
export function extractToc(markdown: string): TocHeading[] {
  const headings: TocHeading[] = [];

  const tree = unified().use(remarkParse).parse(markdown);

  visit(tree, "heading", (node: any) => {
    if (node.depth >= 2 && node.depth <= 3) {
      // Extract text from all child text/inlineCode nodes
      const text = node.children
        .map((child: any) => {
          if (child.type === "text") return child.value;
          if (child.type === "inlineCode") return child.value;
          return "";
        })
        .join("");

      // Generate slug (must match rehype-slug output)
      const slug = text
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-|-$/g, "");

      if (text && slug) {
        headings.push({ depth: node.depth, text, slug });
      }
    }
  });

  return headings;
}
```

Note: This is synchronous (uses `.parse()` not `.process()`) since we only need the AST, not the full pipeline output.

**src/components/ui/ArticleSidebar.tsx — New file: Sticky sidebar component**

This is a Server Component (no "use client"). It receives article metadata and TOC headings as props.

```tsx
import Link from "next/link";
import type { Article } from "@/types/content";
import type { TocHeading } from "@/lib/toc";
import { StatusBadge } from "./StatusBadge";
import { tagToSlug } from "@/lib/tags";

interface ArticleSidebarProps {
  article: Article;
  headings: TocHeading[];
}

const categoryColors: Record<string, string> = {
  models: "#8B5CF6",
  tools: "#00E5CC",
  skills: "#FFB347",
  repos: "#F472B6",
  agents: "#38BDF8",
  projects: "#34D399",
};

export function ArticleSidebar({ article, headings }: ArticleSidebarProps) {
  return (
    <aside className="space-y-6 lg:sticky lg:top-24 lg:h-fit">
      {/* Status badge */}
      <StatusBadge status={article.status} />

      {/* Metadata */}
      <div className="space-y-3 text-sm">
        {article.author && (
          <div>
            <span className="text-muted">Author</span>
            <p className="font-medium text-primary">{article.author}</p>
          </div>
        )}
        <div>
          <span className="text-muted">Created</span>
          <p className="font-medium text-primary">
            <time dateTime={article.created.toISOString()}>
              {article.created.toLocaleDateString()}
            </time>
          </p>
        </div>
        {article.updated && (
          <div>
            <span className="text-muted">Updated</span>
            <p className="font-medium text-primary">
              <time dateTime={article.updated.toISOString()}>
                {article.updated.toLocaleDateString()}
              </time>
            </p>
          </div>
        )}
      </div>

      {/* Tags */}
      {article.tags && article.tags.length > 0 && (
        <div>
          <h4 className="mb-2 text-xs font-bold uppercase tracking-wider text-muted">Tags</h4>
          <div className="flex flex-wrap gap-2">
            {article.tags.map((tag) => (
              <Link
                key={tag}
                href={`/tags/${tagToSlug(tag)}`}
                className="rounded-pill border border-white/[0.08] bg-glass px-3 py-1 text-xs text-muted transition-colors hover:border-white/[0.16] hover:text-primary"
              >
                {tag}
              </Link>
            ))}
          </div>
        </div>
      )}

      {/* Table of contents */}
      {headings.length > 0 && (
        <nav aria-label="Table of contents">
          <h4 className="mb-3 text-xs font-bold uppercase tracking-wider text-muted">
            On this page
          </h4>
          <ul className="space-y-1">
            {headings.map((heading) => (
              <li key={heading.slug}>
                <a
                  href={`#${heading.slug}`}
                  className={`block py-1 text-sm transition-colors hover:text-teal ${
                    heading.depth === 3
                      ? "pl-4 text-muted"
                      : "font-medium text-primary"
                  }`}
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </nav>
      )}
    </aside>
  );
}
```

Sidebar is `lg:sticky lg:top-24 lg:h-fit` — sticks on desktop, flows naturally on mobile/tablet. The `h-fit` prevents the sidebar from stretching to full grid height.
  </action>
  <verify>Run `npx next build` — no TypeScript errors in new files. Verify `unist-util-visit` is installed (check package.json).</verify>
  <done>TOC extraction utility extracts h2/h3 headings with slugs from markdown. ArticleSidebar component renders status badge, metadata, tags, and TOC in a sticky container.</done>
</task>

<task type="auto">
  <name>Task 2: Article page two-column layout and RelatedArticles redesign</name>
  <files>src/app/[category]/[slug]/page.tsx, src/components/ui/RelatedArticles.tsx</files>
  <action>
**src/app/[category]/[slug]/page.tsx — Rewrite with two-column layout:**

Add imports for new components:
```tsx
import { extractToc } from "@/lib/toc";
import { ArticleSidebar } from "@/components/ui/ArticleSidebar";
import rehypeSlug from "rehype-slug";
```

Install `rehype-slug` for heading IDs: `npm install rehype-slug`

Add rehype-slug to the unified pipeline (BEFORE rehype-pretty-code) so headings get IDs that match TOC anchors:
```tsx
.use(rehypeSlug)
```

Remove the `ArticleMetadata` import (sidebar replaces it).

Update the page structure:

```tsx
export default async function ArticlePage({ params }) {
  const { category, slug } = await params;
  const articles = await fetchCategoryArticles(category);
  const article = articles.find((a) => a.slug === slug);

  if (!article) notFound();

  const capitalizedCategory = category.charAt(0).toUpperCase() + category.slice(1);
  const relatedArticles = await getRelatedArticles(article, 3);
  const headings = extractToc(article.content);
  const categoryColor = categoryColors[category] || "#94A3B8";

  // Render markdown
  const htmlContent = String(
    await unified()
      .use(remarkParse)
      .use(remarkGfm)
      .use(remarkRehype, { allowDangerousHtml: true })
      .use(rehypeSlug)
      .use(rehypePrettyCode, { theme: "github-dark-dimmed", keepBackground: true })
      .use(rehypeStringify, { allowDangerousHtml: true })
      .process(article.content)
  );

  return (
    <div className="mx-auto max-w-7xl px-6 py-12">
      {/* Back link as pill button */}
      <Link
        href={`/${category}`}
        className="mb-8 inline-flex items-center gap-2 rounded-pill border border-white/[0.08] bg-glass px-4 py-2 text-sm font-medium text-teal backdrop-blur-sm transition-colors hover:border-teal/50 hover:bg-teal/10"
      >
        <span aria-hidden="true">←</span>
        Back to {capitalizedCategory}
      </Link>

      {/* Article header */}
      <header className="mb-12">
        <Link
          href={`/${category}`}
          className="mb-3 inline-block text-sm font-semibold"
          style={{ color: categoryColor }}
        >
          {capitalizedCategory}
        </Link>
        <h1 className="mb-4 font-display text-3xl font-extrabold tracking-tight text-primary md:text-4xl lg:text-5xl" style={{ fontSize: "clamp(1.75rem, calc(1.25rem + 2.5vw), 2.5rem)" }}>
          {article.title}
        </h1>
        {/* Accent bar */}
        <div className="h-1 w-16 rounded-full" style={{ backgroundColor: categoryColor }} />
      </header>

      {/* Two-column layout */}
      <div className="grid gap-12 lg:grid-cols-[260px_1fr]">
        {/* Sidebar — metadata grid on tablet, sticky on desktop */}
        <div className="grid grid-cols-1 gap-6 xs:grid-cols-2 lg:block">
          <ArticleSidebar article={article} headings={headings} />
        </div>

        {/* Article content */}
        <article className="min-w-0">
          <div
            className="prose prose-invert max-w-[75ch] prose-headings:font-display prose-headings:font-bold prose-headings:tracking-tight prose-a:text-teal prose-a:underline prose-blockquote:border-purple prose-blockquote:bg-purple/[0.08] prose-blockquote:rounded-r-lg prose-code:text-teal prose-code:bg-code-bg prose-code:rounded prose-code:border prose-code:border-white/[0.08] prose-code:px-1.5 prose-code:py-0.5 prose-code:before:content-[''] prose-code:after:content-['']"
            dangerouslySetInnerHTML={{ __html: htmlContent }}
          />
        </article>
      </div>

      {/* Related articles */}
      <RelatedArticles articles={relatedArticles} category={category} />
    </div>
  );
}
```

Define categoryColors at the top of the file:
```tsx
const categoryColors: Record<string, string> = {
  models: "#8B5CF6",
  tools: "#00E5CC",
  skills: "#FFB347",
  repos: "#F472B6",
  agents: "#38BDF8",
  projects: "#34D399",
};
```

Note on prose classes:
- `prose-invert` sets up dark mode prose colors
- `prose-headings:font-display` applies Cabinet Grotesk to all headings
- `prose-code:before:content-[''] prose-code:after:content-['']` removes the backtick decorators that Tailwind typography adds around inline code
- `prose-blockquote:border-purple` uses the theme color
- `prose-a:text-teal` for teal links

Note on responsive sidebar:
- On desktop (lg+): sidebar is a 260px column, sticky positioned
- On tablet (md-lg): sidebar content renders as a 2-column grid above content via the wrapper `grid grid-cols-1 gap-6 xs:grid-cols-2 lg:block`
- On small mobile (< 30rem/xs): single column everything

**src/components/ui/RelatedArticles.tsx — Redesign with colored top borders:**

```tsx
import Link from "next/link";
import type { Article } from "@/types/content";

interface RelatedArticlesProps {
  articles: Article[];
  category?: string;
}

const categoryColors: Record<string, string> = {
  models: "#8B5CF6",
  tools: "#00E5CC",
  skills: "#FFB347",
  repos: "#F472B6",
  agents: "#38BDF8",
  projects: "#34D399",
};

export function RelatedArticles({ articles }: RelatedArticlesProps) {
  if (articles.length === 0) {
    return null;
  }

  return (
    <section className="mt-16 border-t border-white/[0.08] pt-12">
      <h2 className="mb-8 font-display text-2xl font-bold tracking-tight text-primary">
        Related Articles
      </h2>

      <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
        {articles.map((article) => {
          const color = categoryColors[article.category] || "#94A3B8";
          const capitalizedCategory = article.category.charAt(0).toUpperCase() + article.category.slice(1);

          return (
            <Link
              key={`${article.category}-${article.slug}`}
              href={`/${article.category}/${article.slug}`}
              className="group rounded-xl border border-white/[0.08] bg-glass p-5 transition-all duration-200 hover:border-white/[0.16] hover:shadow-md"
            >
              {/* Colored top border */}
              <div className="mb-4 h-0.5 w-12 rounded-full" style={{ backgroundColor: color }} />

              <span className="mb-1 block text-xs font-semibold" style={{ color }}>
                {capitalizedCategory}
              </span>
              <h3 className="mb-2 font-display text-base font-bold leading-tight tracking-tight text-primary transition-colors group-hover:text-teal">
                {article.title}
              </h3>
              <time
                dateTime={article.updated.toISOString()}
                className="text-xs text-muted"
              >
                {article.updated.toLocaleDateString()}
              </time>
            </Link>
          );
        })}
      </div>
    </section>
  );
}
```

Note: RelatedArticles no longer uses ArticleCard — it has its own compact card design with colored top border, category label, title, and date. This matches the variant-2-color design.

Update the RelatedArticlesProps to accept optional `category` prop for future use, but the component gets each article's category from `article.category` directly.

Remove the `ArticleCard` import from RelatedArticles since it now renders its own cards.
  </action>
  <verify>
Run `npm install rehype-slug` if not already installed.
Run `npx next build` — build succeeds. Article pages generate with two-column layout. Heading IDs match TOC anchors.
  </verify>
  <done>Article page has two-column layout with sticky sidebar (metadata, tags, TOC). Prose content has dark theme styling with teal links, purple blockquotes, styled inline code. Related articles display as 3-column grid with colored top borders. TOC links work with heading anchors.</done>
</task>

</tasks>

<verification>
1. `npx next build` succeeds without errors
2. Article page renders two-column layout on desktop (260px sidebar + fluid content)
3. Sidebar contains status badge, author, dates, tags, and TOC
4. TOC extracts h2/h3 headings and renders as clickable anchor links
5. Headings have IDs via rehype-slug that match TOC slugs
6. Sidebar is sticky on desktop, collapses to grid on tablet, single-column on mobile
7. Article prose has dark theme: teal links, purple blockquotes, styled inline code
8. Back link is pill-shaped with teal accent
9. Related articles render as 3-column grid with colored top borders
10. `prose-invert` applies dark mode text colors
</verification>

<success_criteria>
- Two-column article layout works on desktop, collapses correctly on tablet/mobile
- Sticky sidebar stays visible while scrolling article content
- TOC headings link to correct sections within the article
- Prose styling matches dark theme spec (teal links, purple blockquotes, styled code)
- Related articles show category-colored top borders
- Article header has category link, fluid title, and accent bar
- rehype-slug adds IDs to all headings
</success_criteria>

<output>
After completion, create `.planning/phases/08-design-polish/08-03-SUMMARY.md`
</output>
